<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DragonSoul Web — Phase 3.6</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: #0d0d1a;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 16px;
        }
        h1 {
            color: #e94560;
            font-size: 22px;
            margin: 12px 0 4px;
            letter-spacing: 2px;
        }
        .subtitle {
            color: #555;
            font-size: 11px;
            margin-bottom: 12px;
        }
        #status-bar {
            width: 100%;
            max-width: 1280px;
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 6px;
            padding: 8px 16px;
            display: flex;
            gap: 24px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .status-item { display: flex; gap: 8px; align-items: center; }
        .status-label { color: #555; font-size: 11px; }
        .status-value { font-size: 13px; font-weight: bold; }
        .status-value.ok { color: #4eff4e; }
        .status-value.fail { color: #ff4e4e; }
        .status-value.pending { color: #ffcc4e; }
        .status-value.info { color: #4ecaff; }
        #canvas-container {
            width: 100%;
            max-width: 1280px;
            background: #000;
            border: 2px solid #0f3460;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        #game-canvas {
            display: block;
            width: 100%;
            height: auto;
        }
        #overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: rgba(0,0,0,0.85);
            color: #e94560;
            font-size: 20px;
            gap: 12px;
        }
        #overlay.hidden { display: none; }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #0f3460;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #fps-badge {
            position: absolute;
            top: 8px; right: 12px;
            background: rgba(0,0,0,0.6);
            color: #4eff4e;
            font-family: monospace;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #0f3460;
            pointer-events: none;
        }
        #console-section {
            width: 100%;
            max-width: 1280px;
            margin-top: 10px;
        }
        #console-header {
            background: #e94560;
            color: #fff;
            font-weight: bold;
            padding: 6px 14px;
            border-radius: 4px 4px 0 0;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #console-count { font-weight: normal; color: #ffcc4e; }
        #console {
            background: #060610;
            border: 1px solid #0f3460;
            border-top: none;
            border-radius: 0 0 6px 6px;
            padding: 10px 14px;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 320px;
            overflow-y: auto;
            line-height: 1.5;
        }
        .log-info  { color: #aaa; }
        .log-ok    { color: #4eff4e; font-weight: bold; }
        .log-error { color: #ff4e4e; }
        .log-warn  { color: #ffcc4e; }
        .log-phase { color: #e94560; font-weight: bold; font-size: 13px; }
        .log-create { color: #4ecaff; font-weight: bold; }
        .log-render { color: #b0ffa0; }
    </style>
</head>
<body>
    <h1>&#x1F409; DragonSoul Web</h1>
    <div class="subtitle">Phase 3.6 — Boucle RAF + shaders linkés sur GPU + audio stubé</div>

    <div id="status-bar">
        <div class="status-item">
            <span class="status-label">WebGL2</span>
            <span class="status-value pending" id="st-webgl">...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Bridge</span>
            <span class="status-value pending" id="st-bridge">...</span>
        </div>
        <div class="status-item">
            <span class="status-label">create()</span>
            <span class="status-value pending" id="st-create">...</span>
        </div>
        <div class="status-item">
            <span class="status-label">render()</span>
            <span class="status-value pending" id="st-render">...</span>
        </div>
        <div class="status-item">
            <span class="status-label">FPS</span>
            <span class="status-value info" id="st-fps">—</span>
        </div>
        <div class="status-item">
            <span class="status-label">Frames</span>
            <span class="status-value info" id="st-frames">0</span>
        </div>
        <div class="status-item">
            <span class="status-label">Shaders</span>
            <span class="status-value info" id="st-shaders">0</span>
        </div>
        <div class="status-item">
            <span class="status-label">Programs</span>
            <span class="status-value info" id="st-programs">0</span>
        </div>
        <div class="status-item">
            <span class="status-label">DrawCalls</span>
            <span class="status-value info" id="st-draws">0</span>
        </div>
    </div>

    <div id="canvas-container">
        <canvas id="game-canvas" width="1280" height="720"></canvas>
        <div id="fps-badge" style="display:none">0 FPS</div>
        <div id="overlay">
            <div class="spinner"></div>
            <span id="overlay-msg">Chargement classes.js...</span>
        </div>
    </div>

    <div id="console-section">
        <div id="console-header">
            Console DragonSoul
            <span id="console-count">0 lignes</span>
        </div>
        <div id="console"></div>
    </div>

    <script>
    // ─── Console capture ─────────────────────────────────────────────────────
    const consoleDiv   = document.getElementById('console');
    const consoleCount = document.getElementById('console-count');
    let lineCount = 0;
    let shaderCount = 0;
    let programCount = 0;
    let drawCallCount = 0;
    let frameCount = 0;
    let renderErrors = 0;

    function addLog(text, cls) {
        const el = document.createElement('div');
        el.className = cls || 'log-info';
        el.textContent = text;
        consoleDiv.appendChild(el);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
        lineCount++;
        consoleCount.textContent = lineCount + ' lignes';
    }

    function classifyLine(text) {
        if (!text) return 'log-info';
        if (text.includes('Phase 3') || text.includes('PASSED') || text.includes('boucle RAF')) return 'log-phase';
        if (text.includes('game.create()') || text.includes('create()') || text.includes('Premier frame')) return 'log-create';
        if (text.includes('render()') || text.includes('Render')) return 'log-render';
        if (text.includes('[ERROR]') || text.includes('exception') || text.includes('Exception')) return 'log-error';
        if (text.includes('[WARN]') || text.includes('WARNING') || text.includes('WebGL:')) return 'log-warn';
        if (text.includes('OK') || text.includes('COMPLETE') || text.includes('success') || text.includes('termine')) return 'log-ok';
        return 'log-info';
    }

    function logLines(msg) {
        String(msg).split('\n').forEach(line => {
            if (line.trim()) addLog(line, classifyLine(line));
        });
    }

    const _origInfo  = console.info.bind(console);
    const _origLog   = console.log.bind(console);
    const _origWarn  = console.warn.bind(console);
    const _origError = console.error.bind(console);

    console.info  = function(msg) { _origInfo(msg);  logLines(msg); };
    console.log   = function(msg) { _origLog(msg);   logLines(msg); };
    console.warn  = function(msg) { _origWarn(msg);  addLog(String(msg), 'log-warn'); };
    console.error = function(msg) { _origError(msg); addLog(String(msg), 'log-error'); };

    // ─── Status helpers ───────────────────────────────────────────────────────
    function setStatus(id, value, cls) {
        const el = document.getElementById(id);
        el.textContent = value;
        el.className = 'status-value ' + cls;
    }

    function setOverlay(msg, hide) {
        const ov = document.getElementById('overlay');
        if (hide) { ov.classList.add('hidden'); return; }
        document.getElementById('overlay-msg').textContent = msg;
    }

    // ─── FPS counter ─────────────────────────────────────────────────────────
    let _fpsFrames = 0;
    let _fpsLastTime = performance.now();
    function tickFPS() {
        _fpsFrames++;
        const now = performance.now();
        if (now - _fpsLastTime >= 1000) {
            const fps = Math.round(_fpsFrames * 1000 / (now - _fpsLastTime));
            document.getElementById('st-fps').textContent = fps + ' fps';
            document.getElementById('fps-badge').textContent = fps + ' FPS';
            _fpsFrames = 0;
            _fpsLastTime = now;
        }
    }

    // ─── Render loop ─────────────────────────────────────────────────────────
    let _rafRunning = false;
    let _rafId = null;
    let _renderOk = false;

    function startRenderLoop() {
        if (_rafRunning) return;
        _rafRunning = true;
        document.getElementById('fps-badge').style.display = 'block';
        addLog('Boucle RAF démarrée', 'log-phase');

        function loop() {
            _rafId = requestAnimationFrame(loop);
            try {
                renderFrame();
                frameCount++;
                document.getElementById('st-frames').textContent = frameCount;
                tickFPS();
                if (!_renderOk) {
                    _renderOk = true;
                    setStatus('st-render', 'OK', 'ok');
                    setOverlay('', true);
                    addLog('Premier frame rendu avec succès !', 'log-ok');
                }
            } catch(e) {
                renderErrors++;
                if (renderErrors <= 5) {
                    addLog('render() erreur: ' + e.message, 'log-error');
                    if (e.stack) addLog(e.stack.split('\n').slice(0,8).join(' | '), 'log-error');
                }
                if (renderErrors > 20) {
                    cancelAnimationFrame(_rafId);
                    _rafRunning = false;
                    setStatus('st-render', 'STOPPED', 'fail');
                    addLog('Boucle RAF arrêtée (trop d\'erreurs)', 'log-error');
                }
            }
        }
        requestAnimationFrame(loop);
    }

    // ─── Main boot sequence ───────────────────────────────────────────────────
    window.addEventListener('load', function() {
        const canvas = document.getElementById('game-canvas');

        // 1. Check WebGL2 support
        const testCtx = canvas.getContext('webgl2');
        if (!testCtx) {
            setStatus('st-webgl', 'N/A', 'fail');
            setOverlay('WebGL2 non supporté par ce navigateur');
            addLog('ERROR: WebGL2 not supported', 'log-error');
            return;
        }
        setStatus('st-webgl', 'OK', 'ok');
        addLog('WebGL2: ' + (testCtx.getParameter(testCtx.VERSION) || 'WebGL 2.0'), 'log-ok');

        setOverlay('Initialisation bridge WebGL2...');

        if (typeof setupWebGL2 !== 'function') {
            setStatus('st-bridge', 'absent', 'fail');
            addLog('ERROR: setupWebGL2 non trouvé dans classes.js', 'log-error');
            setOverlay('Erreur : bridge WebGL2 absent');
            return;
        }

        // 2. Activate WebGL2 bridge (sets window._webGL2Active = true)
        try {
            const bridgeOk = setupWebGL2(canvas);
            if (bridgeOk) {
                setStatus('st-bridge', 'OK', 'ok');
                addLog('Bridge WebGL2 Phase 3.6 actif', 'log-ok');
            } else {
                setStatus('st-bridge', 'FAIL', 'fail');
                addLog('WARN: setupWebGL2 returned false', 'log-warn');
            }
        } catch(e) {
            setStatus('st-bridge', 'ERROR', 'fail');
            addLog('ERROR bridge: ' + e.message, 'log-error');
            return;
        }

        // Instrument WebGL20 to count shaders, programs, draw calls
        if (typeof WebGL20 !== 'undefined') {
            const P = WebGL20.prototype;
            const _cs = P.$glCreateShader;
            P.$glCreateShader = function(t) {
                const h = _cs.call(this, t);
                if (h) { shaderCount++; document.getElementById('st-shaders').textContent = shaderCount; }
                return h;
            };
            const _cp = P.$glCreateProgram;
            P.$glCreateProgram = function() {
                const h = _cp.call(this);
                if (h) { programCount++; document.getElementById('st-programs').textContent = programCount; }
                return h;
            };
            const _da = P.$glDrawArrays;
            P.$glDrawArrays = function(m,f,c) {
                drawCallCount++; document.getElementById('st-draws').textContent = drawCallCount;
                return _da.call(this, m, f, c);
            };
            const _de = P.$glDrawElements;
            P.$glDrawElements = function(m,c,t,o) {
                drawCallCount++; document.getElementById('st-draws').textContent = drawCallCount;
                return _de.call(this, m, c, t, o);
            };
        }

        setOverlay('Lancement game.create()...');

        // 3. Run main() — calls game.create() + first renderFrame()
        setStatus('st-create', 'running...', 'pending');
        setStatus('st-render', 'waiting...', 'pending');
        try {
            main([]);
            setStatus('st-create', 'OK', 'ok');
            addLog('game.create() + premier frame OK', 'log-ok');
            // 4. Start the RAF render loop
            startRenderLoop();
        } catch(e) {
            const msg = e.message || String(e);
            setStatus('st-create', 'EXCEPTION', 'fail');
            addLog('game.create() exception: ' + msg, 'log-error');
            if (e.stack) addLog(e.stack.split('\n').slice(0,6).join('\n'), 'log-error');
            setOverlay('Exception — voir console');
        }
    });
    </script>

    <!--
        classes.js exports:
          window.main           — TeaVM entry point (appelle game.create() + premier frame)
          window.renderFrame    — appelle game.render() (utilisé par la boucle RAF)
          window.setupWebGL2    — active le bridge WebGL2
          window.$rt_ustr       — TeaVM string → JS string
          window.$rt_str        — JS string → TeaVM string
    -->
    <!-- game-assets.js DOIT être chargé avant classes.js -->
    <script src="game-assets.js"></script>
    <script src="classes.js" onerror="
        document.getElementById('overlay-msg').textContent = 'Erreur: classes.js introuvable';
        document.getElementById('st-bridge').textContent = 'N/A';
        document.getElementById('st-bridge').className = 'status-value fail';
        document.getElementById('console').innerHTML = '<div class=\'log-error\'>classes.js non trouvé. Lancez un serveur HTTP dans proto/output/web/</div>';
    "></script>
</body>
</html>
