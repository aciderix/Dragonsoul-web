<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DragonSoul Web — Phase 3.4</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: #0d0d1a;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 16px;
        }
        h1 {
            color: #e94560;
            font-size: 22px;
            margin: 12px 0 4px;
            letter-spacing: 2px;
        }
        .subtitle {
            color: #555;
            font-size: 11px;
            margin-bottom: 12px;
        }
        #status-bar {
            width: 100%;
            max-width: 1280px;
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 6px;
            padding: 8px 16px;
            display: flex;
            gap: 24px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .status-item { display: flex; gap: 8px; align-items: center; }
        .status-label { color: #555; font-size: 11px; }
        .status-value { font-size: 13px; font-weight: bold; }
        .status-value.ok { color: #4eff4e; }
        .status-value.fail { color: #ff4e4e; }
        .status-value.pending { color: #ffcc4e; }
        .status-value.info { color: #4ecaff; }
        #canvas-container {
            width: 100%;
            max-width: 1280px;
            background: #000;
            border: 2px solid #0f3460;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        #game-canvas {
            display: block;
            width: 100%;
            height: auto;
        }
        #overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: rgba(0,0,0,0.85);
            color: #e94560;
            font-size: 20px;
            gap: 12px;
        }
        #overlay.hidden { display: none; }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #0f3460;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #console-section {
            width: 100%;
            max-width: 1280px;
            margin-top: 10px;
        }
        #console-header {
            background: #e94560;
            color: #fff;
            font-weight: bold;
            padding: 6px 14px;
            border-radius: 4px 4px 0 0;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #console-count { font-weight: normal; color: #ffcc4e; }
        #console {
            background: #060610;
            border: 1px solid #0f3460;
            border-top: none;
            border-radius: 0 0 6px 6px;
            padding: 10px 14px;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 320px;
            overflow-y: auto;
            line-height: 1.5;
        }
        .log-info  { color: #aaa; }
        .log-ok    { color: #4eff4e; font-weight: bold; }
        .log-error { color: #ff4e4e; }
        .log-warn  { color: #ffcc4e; }
        .log-phase { color: #e94560; font-weight: bold; font-size: 13px; }
        .log-create { color: #4ecaff; font-weight: bold; }
    </style>
</head>
<body>
    <h1>&#x1F409; DragonSoul Web</h1>
    <div class="subtitle">Phase 3.5 — Java → TeaVM JS + WebGL2 bridge + assets réels</div>

    <div id="status-bar">
        <div class="status-item">
            <span class="status-label">WebGL2</span>
            <span class="status-value pending" id="st-webgl">...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Bridge</span>
            <span class="status-value pending" id="st-bridge">...</span>
        </div>
        <div class="status-item">
            <span class="status-label">game.create()</span>
            <span class="status-value pending" id="st-create">...</span>
        </div>
        <div class="status-item">
            <span class="status-label">GL Shaders</span>
            <span class="status-value info" id="st-shaders">0</span>
        </div>
        <div class="status-item">
            <span class="status-label">GL Programs</span>
            <span class="status-value info" id="st-programs">0</span>
        </div>
        <div class="status-item">
            <span class="status-label">GL Calls</span>
            <span class="status-value info" id="st-glcalls">0</span>
        </div>
    </div>

    <div id="canvas-container">
        <canvas id="game-canvas" width="1280" height="720"></canvas>
        <div id="overlay">
            <div class="spinner"></div>
            <span id="overlay-msg">Chargement classes.js...</span>
        </div>
    </div>

    <div id="console-section">
        <div id="console-header">
            Console TeaVM
            <span id="console-count">0 lignes</span>
        </div>
        <div id="console"></div>
    </div>

    <script>
    // ─── Console capture ─────────────────────────────────────────────────────
    const consoleDiv  = document.getElementById('console');
    const consoleCount = document.getElementById('console-count');
    let lineCount = 0;
    let shaderCount = 0;
    let programCount = 0;
    let glCallCount = 0;

    function addLog(text, cls) {
        const el = document.createElement('div');
        el.className = cls || 'log-info';
        el.textContent = text;
        consoleDiv.appendChild(el);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
        lineCount++;
        consoleCount.textContent = lineCount + ' lignes';
    }

    function classifyLine(text) {
        if (!text) return 'log-info';
        if (text.includes('game.create() termin') || text.includes('PASSED') || text.includes('Phase 3')) return 'log-phase';
        if (text.includes('game.create()') || text.includes('create()')) return 'log-create';
        if (text.includes('[ERROR]') || text.includes('exception') || text.includes('Exception')) return 'log-error';
        if (text.includes('[WARN]') || text.includes('WARNING')) return 'log-warn';
        if (text.includes('OK') || text.includes('COMPLETE') || text.includes('success')) return 'log-ok';
        return 'log-info';
    }

    function logLines(msg) {
        String(msg).split('\n').forEach(line => {
            if (line.trim()) addLog(line, classifyLine(line));
        });
    }

    // Intercept TeaVM's console.info output
    const _origInfo  = console.info.bind(console);
    const _origLog   = console.log.bind(console);
    const _origWarn  = console.warn.bind(console);
    const _origError = console.error.bind(console);

    console.info  = function(msg) { _origInfo(msg);  logLines(msg); };
    console.log   = function(msg) { _origLog(msg);   logLines(msg); };
    console.warn  = function(msg) { _origWarn(msg);  addLog(String(msg), 'log-warn'); };
    console.error = function(msg) { _origError(msg); addLog(String(msg), 'log-error'); };

    // ─── Status helpers ───────────────────────────────────────────────────────
    function setStatus(id, value, cls) {
        const el = document.getElementById(id);
        el.textContent = value;
        el.className = 'status-value ' + cls;
    }

    function setOverlay(msg, hide) {
        const ov = document.getElementById('overlay');
        if (hide) { ov.classList.add('hidden'); return; }
        document.getElementById('overlay-msg').textContent = msg;
    }

    // ─── GL instrumentation wrapper (count calls) ─────────────────────────────
    function wrapBridgeForStats(exports) {
        // We patch setupWebGL2 to also count GL calls
        const origSetup = exports.setupWebGL2;
        exports.setupWebGL2 = function(canvas) {
            const ok = origSetup(canvas);
            if (!ok) return ok;

            // After bridge is set up, wrap a few key calls to count stats
            // (These already point at real WebGL functions via the bridge)
            const proto = window.WebGL20 ? window.WebGL20.prototype : null;
            if (!proto) return ok;

            const origCreateShader = proto.$glCreateShader;
            proto.$glCreateShader = function(type) {
                const h = origCreateShader.call(this, type);
                if (h) { shaderCount++; document.getElementById('st-shaders').textContent = shaderCount; }
                glCallCount++; document.getElementById('st-glcalls').textContent = glCallCount;
                return h;
            };

            const origCreateProgram = proto.$glCreateProgram;
            proto.$glCreateProgram = function() {
                const h = origCreateProgram.call(this);
                if (h) { programCount++; document.getElementById('st-programs').textContent = programCount; }
                glCallCount++; document.getElementById('st-glcalls').textContent = glCallCount;
                return h;
            };

            return ok;
        };
    }

    // ─── Main boot sequence ───────────────────────────────────────────────────
    window.addEventListener('load', function() {
        const canvas = document.getElementById('game-canvas');

        // 1. Check WebGL2 support
        const testCtx = canvas.getContext('webgl2');
        if (!testCtx) {
            setStatus('st-webgl', 'N/A', 'fail');
            setOverlay('WebGL2 non supporté par ce navigateur');
            addLog('ERROR: WebGL2 not supported', 'log-error');
            return;
        }
        setStatus('st-webgl', 'OK', 'ok');
        addLog('WebGL2 disponible: ' + (testCtx.getParameter(testCtx.VERSION) || 'WebGL 2.0'), 'log-ok');

        setOverlay('Script chargé, initialisation...');

        // classes.js is already loaded (script tag below), window.main + window.setupWebGL2 should exist
        if (typeof setupWebGL2 !== 'function') {
            setStatus('st-bridge', 'absent', 'fail');
            addLog('ERROR: setupWebGL2 non trouvé — bridge absent de classes.js', 'log-error');
            setOverlay('Erreur : bridge WebGL2 absent');
            return;
        }

        // 2. Activate WebGL2 bridge
        try {
            const bridgeOk = setupWebGL2(canvas);
            if (bridgeOk) {
                setStatus('st-bridge', 'OK', 'ok');
                addLog('Bridge WebGL2 activé', 'log-ok');
            } else {
                setStatus('st-bridge', 'FAIL', 'fail');
                addLog('WARN: setupWebGL2 returned false (canvas sans contexte?)', 'log-warn');
            }
        } catch(e) {
            setStatus('st-bridge', 'ERROR', 'fail');
            addLog('ERROR bridge: ' + e.message, 'log-error');
        }

        setOverlay('Démarrage game.create()...');

        // 3. Run main()
        setStatus('st-create', 'running...', 'pending');
        try {
            main([]);
            setStatus('st-create', 'OK', 'ok');
            addLog('game.create() terminé sans exception', 'log-ok');
            setOverlay('', true);
        } catch(e) {
            const msg = e.message || String(e);
            setStatus('st-create', 'EXCEPTION', 'fail');
            addLog('game.create() exception: ' + msg, 'log-error');
            if (e.stack) addLog(e.stack.split('\n').slice(0,5).join('\n'), 'log-error');
            setOverlay('Exception — voir console');
        }
    });
    </script>

    <!--
        classes.js exports in browser mode:
          window.main           — the TeaVM entry point
          window.setupWebGL2    — bridges WebGL20 prototype to real WebGL2 (Fix 28)
          window.$rt_ustr       — TeaVM string → JS string
          window.$rt_str        — JS string → TeaVM string
    -->
    <!-- game-assets.js must load BEFORE classes.js — provides window.GAME_ASSETS -->
    <script src="game-assets.js"></script>
    <script src="classes.js" onerror="
        document.getElementById('overlay-msg').textContent = 'Erreur: classes.js introuvable';
        document.getElementById('st-bridge').textContent = 'N/A';
        document.getElementById('st-bridge').className = 'status-value fail';
        document.getElementById('console').innerHTML = '<div class=\'log-error\'>classes.js non trouvé. Lancez un serveur HTTP dans proto/output/web/</div>';
    "></script>
</body>
</html>
